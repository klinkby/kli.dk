server.document-root = "/app"
server.bind = "/var/run/lighttpd/sock"
server.errorlog = "/proc/self/fd/2"
server.pid-file = "/tmp/lighttpd.pid"
server.follow-symlink = "disable"
server.error-handler-404 = "/404/index.html"
server.modules = ( "mod_redirect", "mod_setenv" )

index-file.names = ( "index.html" )

# 301 redirect /sitemap.xml -> /index.xml
url.redirect-code = 301
url.redirect = ( "^/sitemap\.xml$" => "/index.xml" )

# Cache control: HTML, XML, JSON -- 1 day (matching config.toml)
$HTTP["url"] =~ "\.(html|xml|json)$" {
  setenv.add-response-header += ( "Cache-Control" => "public, max-age=86400" )
}

# Cache control: static assets -- 180 days (matching config.toml)
$HTTP["url"] =~ "\.(css|js|svg|png|jpg|jpeg|gif|ico|woff|woff2|ttf|eot|zip)$" {
  setenv.add-response-header += ( "Cache-Control" => "public, max-age=15552000, immutable" )
}

# Security headers
setenv.add-response-header = (
  "Content-Security-Policy" => "default-src https: 'self'; style-src 'self' 'unsafe-inline'; object-src 'none'; frame-src 'self'; img-src 'self' https://cdn.fosstodon.org",
  "X-Frame-Options" => "SAMEORIGIN",
  "X-Content-Type-Options" => "nosniff",
  "Referrer-Policy" => "same-origin",
  "Permissions-Policy" => "geolocation=(), microphone=(), camera=()"
)

mimetype.assign = (
  ".html"  => "text/html; charset=utf-8",
  ".css"   => "text/css",
  ".js"    => "application/javascript",
  ".json"  => "application/json",
  ".xml"   => "application/xml",
  ".svg"   => "image/svg+xml",
  ".png"   => "image/png",
  ".jpg"   => "image/jpeg",
  ".jpeg"  => "image/jpeg",
  ".ico"   => "image/x-icon",
  ".txt"   => "text/plain",
  ".woff"  => "font/woff",
  ".woff2" => "font/woff2",
  ".ttf"   => "font/ttf",
  ".eot"   => "application/vnd.ms-fontobject",
  ".zip"   => "application/zip"
)
